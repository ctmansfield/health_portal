{% extends "base.html" %}
{% block title %}Dashboard — Health Portal{% endblock %}
{% block head %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}
{% block extra_head %}{% endblock %}
{% block content %}
  <main class="container">
    <div class="controls">
      <form method="get" class="form-inline">
        <label>Person: <input type="text" name="person_id" value="{{ person_id }}"></label>
        <label>Days: <input type="number" name="days" value="{{ days }}" min="1" max="365"></label>
        <button type="submit" class="btn">Refresh</button>
      </form>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <a href="/logout" class="header-link">Logout</a>
      </div>
    </div>

    <div class="dashboard-main">
      <section class="panel chart-panel">
        <h2>Median HR (Daily)</h2>
        <div class="chart-wrap" data-chart="hrDaily">
          <canvas id="hrDaily"></canvas>
        </div>
      </section>

      <aside class="panel summary-card">
        <h2>Summary</h2>
        <div class="kv">
          <div><strong>Person</strong><div>{{ person_id }}</div></div>
          <div><strong>Window</strong><div>Last {{ days }} days</div></div>
        </div>
        <div class="mt-12">
          <a href="/dashboard?person_id={{ person_id }}&days={{ days }}">Refresh</a> · <a href="/ui/people/{{ person_id }}/labs/critical?preview=1">View Labs Charts</a>
        </div>
        <div class="flex-row mt-12">
          <div style="flex:1">
            <div class="text-small">Latest HR</div>
            <div class="value-large">{{ hr_values[-1] if hr_values|length else '—' }}</div>
            <canvas id="hrSpark" width="200" height="40"></canvas>
          </div>
          <div style="flex:1">
            <div class="text-small">Min SpO2 (recent)</div>
            <div class="value-large">{{ (spo2_values|last)|round(2) if spo2_values|length else '—' }}</div>
            <canvas id="spo2Spark" width="200" height="40"></canvas>
          </div>
        </div>
        <div class="mt-16">
          <h3 class="mb-8">SpO2 (Daily Min)</h3>
          <canvas id="spo2Chart" width="400" height="150"></canvas>
        </div>
      </aside>
    </div>

    <div class="card mt-18">
      <h2>Recent AI Findings</h2>
      <div class="table">
      <table>
        <thead><tr><th>Time</th><th>Metric</th><th>Level</th><th>Score</th><th>Context</th></tr></thead>
        <tbody>
        {% for f in findings %}
          <tr>
            <td>{{ f.finding_time }}</td>
            <td>{{ f.metric }}</td>
            <td><span class="badge">{{ f.level }}</span></td>
            <td>{{ '%.2f'|format(f.score) }}</td>
            <td>{{ f.context }}</td>
          </tr>
        {% endfor %}
        {% if findings|length == 0 %}
          <tr><td colspan="5">No findings in this time window.</td></tr>
        {% endif %}
        </tbody>
      </table>
      </div>
    </div>

    <div class="footer">Data from analytics views. Last updated: server time.</div>
  </main>

<script>
window.hrLabels = {{ labels | tojson }};
window.hrData = {{ hr_values | tojson }};
window.spo2Data = {{ spo2_values | tojson }};
</script>
<script src="/static/js/dashboard_charts.js" defer></script>

{% endblock %}
