<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Events</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="header"><h1>Events</h1></div>
  <div class="container">
    <div class="card">
      <h2>Recent Events</h2>
      <div class="table">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <label>Metric:
            <select id="metricSelect">
              <option value="">Any</option>
              <option value="hr">HR</option>
              <option value="spo2">SpO2</option>
            </select>
          </label>
          <label>Day: <input type="date" id="dayInput"></label>
          <button id="refreshBtn">Refresh</button>
        </div>
        <table>
          <thead><tr><th>Time</th><th>Code</th><th>Value</th><th>Unit</th><th>Meta</th></tr></thead>
          <tbody id="eventsBody">
          </tbody>
        </table>
      </div>
      <script>
        async function fetchEvents(){
          const person = new URLSearchParams(window.location.search).get('person_id') || 'me';
          const metric = document.getElementById('metricSelect').value;
          const day = document.getElementById('dayInput').value;
          const qs = new URLSearchParams();
          qs.set('person_id', person);
          if(metric) qs.set('metric', metric);
          if(day) qs.set('day', day);
          const res = await fetch('/dashboard/events.json?'+qs.toString(), {credentials: 'same-origin'});
          const items = await res.json();
          const tbody = document.getElementById('eventsBody');
          tbody.innerHTML = '';
          if(!items || items.length === 0){
            tbody.innerHTML = '<tr><td colspan="5">No events found.</td></tr>';
            return;
          }
          for(const e of items){
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${e.effective_time}</td><td>${e.display || e.code}</td><td>${e.value_num}</td><td>${e.unit}</td><td>${JSON.stringify(e.meta)}</td>`;
            tbody.appendChild(tr);
          }
        }
        document.getElementById('refreshBtn').addEventListener('click', (ev)=>{ ev.preventDefault(); fetchEvents(); });
        // initial load
        fetchEvents();
      </script>
    </div>
  </div>
</body>
</html>
